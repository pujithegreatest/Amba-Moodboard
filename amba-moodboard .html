<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>Amba Moodboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a12;
      --bg-secondary: #12121a;
      --bg-card: #1a1a25;
      --bg-modal: #15151f;
      --accent-green: #00ff66;
      --accent-cyan: #00ffff;
      --accent-purple: #ff00ff;
      --accent-blue: #0088ff;
      --accent-orange: #ff6600;
      --accent-red: #ff0044;
      --accent-yellow: #ffff00;
      --text-primary: #ffffff;
      --text-secondary: #aabbcc;
      --text-muted: #667788;
      --border-color: #2a2a3a;
      --shadow-glow: 0 0 30px rgba(0, 255, 102, 0.3);
    }
    /* Theme: Vapor */
    body.theme-vapor { --bg-primary: #1a0a2e; --bg-secondary: #2d1b4e; --bg-card: #3d2b5e; --accent-green: #ff71ce; --accent-cyan: #01cdfe; --accent-purple: #b967ff; --border-color: #4a3a6a; }
    /* Theme: Sunset */
    body.theme-sunset { --bg-primary: #1a0f0a; --bg-secondary: #2d1810; --bg-card: #3d2820; --accent-green: #ff6b35; --accent-cyan: #ffd700; --accent-purple: #ff4757; --border-color: #4a3830; }
    /* Theme: Matrix */
    body.theme-matrix { --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-card: #111111; --accent-green: #00ff00; --accent-cyan: #00dd00; --accent-purple: #00bb00; --border-color: #003300; }
    /* Theme: Ocean */
    body.theme-ocean { --bg-primary: #0a1628; --bg-secondary: #122a4e; --bg-card: #1a3a5e; --accent-green: #00d4ff; --accent-cyan: #00ffff; --accent-purple: #7b68ee; --border-color: #2a4a6a; }
    /* Theme: Sakura */
    body.theme-sakura { --bg-primary: #1a0f14; --bg-secondary: #2d1820; --bg-card: #3d2830; --accent-green: #ffb7c5; --accent-cyan: #ffc0cb; --accent-purple: #ff69b4; --border-color: #4a3840; }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Orbitron', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; transition: all 0.3s ease; }
    .crt-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px); pointer-events: none; z-index: 9999; opacity: 0.6; }
    .bg-gradient { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at 10% 10%, color-mix(in srgb, var(--accent-green) 15%, transparent) 0%, transparent 40%), radial-gradient(ellipse at 90% 20%, color-mix(in srgb, var(--accent-purple) 10%, transparent) 0%, transparent 40%), radial-gradient(ellipse at 50% 80%, color-mix(in srgb, var(--accent-cyan) 8%, transparent) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .grid-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(color-mix(in srgb, var(--accent-green) 3%, transparent) 1px, transparent 1px), linear-gradient(90deg, color-mix(in srgb, var(--accent-green) 3%, transparent) 1px, transparent 1px); background-size: 50px 50px; pointer-events: none; z-index: 1; }
    .container { position: relative; z-index: 2; max-width: 1400px; margin: 0 auto; padding: 1rem; }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--accent-green); position: relative; flex-wrap: wrap; gap: 1rem; }
    header::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan), var(--accent-purple), var(--accent-green)); background-size: 200% 100%; animation: gradientMove 3s linear infinite; }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
    
    .logo { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
    .logo-icon { width: 50px; height: 50px; border-radius: 10px; overflow: hidden; box-shadow: var(--shadow-glow); border: 2px solid var(--accent-green); animation: pulse 2s ease-in-out infinite; }
    .logo-icon img { width: 100%; height: 100%; object-fit: cover; }
    @keyframes pulse { 0%, 100% { box-shadow: var(--shadow-glow); } 50% { box-shadow: 0 0 50px color-mix(in srgb, var(--accent-green) 50%, transparent); } }
    .logo h1 { font-family: 'Press Start 2P', cursive; font-size: 0.75rem; color: var(--accent-green); text-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green); letter-spacing: 1px; line-height: 1.4; }
    
    .header-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; justify-content: flex-end; flex: 1; }
    .theme-picker { display: flex; gap: 0.4rem; order: -1; width: 100%; justify-content: center; margin-bottom: 0.5rem; }
    .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color); cursor: pointer; transition: all 0.3s ease; }
    .theme-btn:hover { transform: scale(1.2); }
    .theme-btn.active { border-color: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
    .theme-btn.cyber { background: linear-gradient(135deg, #00ff66, #00ffff); }
    .theme-btn.vapor { background: linear-gradient(135deg, #ff71ce, #b967ff); }
    .theme-btn.sunset { background: linear-gradient(135deg, #ff6b35, #ffd700); }
    .theme-btn.matrix { background: linear-gradient(135deg, #00ff00, #003300); }
    .theme-btn.ocean { background: linear-gradient(135deg, #00d4ff, #7b68ee); }
    .theme-btn.sakura { background: linear-gradient(135deg, #ffb7c5, #ff69b4); }
    
    .btn { padding: 0.6rem 1rem; border: 2px solid var(--accent-green); font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.75rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; text-transform: uppercase; letter-spacing: 1px; clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px); touch-action: manipulation; min-height: 44px; }
    .btn-primary { background: var(--accent-green); color: var(--bg-primary); }
    .btn-primary:hover { background: var(--accent-cyan); border-color: var(--accent-cyan); transform: translateY(-2px); }
    .btn-secondary { background: transparent; color: var(--accent-green); }
    .btn-secondary:hover { background: color-mix(in srgb, var(--accent-green) 10%, transparent); }
    .btn-danger { background: transparent; color: var(--accent-red); border-color: var(--accent-red); }
    .btn-danger:hover { background: var(--accent-red); color: white; }
    .btn-small { padding: 0.35rem 0.6rem; font-size: 0.65rem; min-height: 36px; }
    
    .controls-bar { 
      display: flex; 
      margin-bottom: 1.25rem; 
      padding: 0; 
      position: relative; 
      z-index: 2;
    }
    .controls-bar .controls-box {
      display: flex; 
      gap: 1rem; 
      width: 100%;
      padding: 1rem; 
      background: var(--bg-secondary); 
      border: 2px solid var(--accent-green); 
      position: relative;
      align-items: center; 
      flex-wrap: wrap; 
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); 
    }
    .controls-bar::before { 
      content: '[ SYSTEM STATUS ]'; 
      position: absolute; 
      top: -0.6rem; 
      left: 15px; 
      background: var(--bg-primary); 
      padding: 0 8px; 
      font-family: 'Share Tech Mono', monospace; 
      font-size: 0.6rem; 
      color: var(--accent-cyan); 
      letter-spacing: 1px; 
      z-index: 10;
    }
    .stat { text-align: center; flex: 1; min-width: 60px; }
    .stat-value { font-size: 1.5rem; font-weight: 900; color: var(--accent-green); text-shadow: 0 0 10px var(--accent-green); }
    .stat-label { font-family: 'Share Tech Mono', monospace; font-size: 0.6rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px; }
    .controls-right { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; justify-content: flex-end; flex: 2; }
    .control-group { display: flex; align-items: center; gap: 0.3rem; }
    .control-label { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
    .control-select { background: var(--bg-primary); border: 2px solid var(--accent-green); color: var(--accent-green); padding: 0.35rem 0.5rem; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; cursor: pointer; min-height: 36px; border-radius: 0; }
    .control-select:hover, .control-select:focus { outline: none; box-shadow: 0 0 15px color-mix(in srgb, var(--accent-green) 30%, transparent); }
    
    /* Grid View */
    .songs-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    
    /* THEMED SCROLLBAR for Zoetrope */
    .songs-grid.view-zoetrope { 
      display: flex; 
      overflow-x: auto; 
      gap: 1rem; 
      padding-bottom: 1.5rem; 
      scroll-snap-type: x mandatory; 
      -webkit-overflow-scrolling: touch;
      /* Firefox */
      scrollbar-width: thin;
      scrollbar-color: var(--accent-green) var(--bg-secondary);
    }
    /* Webkit scrollbar theming */
    .songs-grid.view-zoetrope::-webkit-scrollbar {
      height: 8px;
    }
    .songs-grid.view-zoetrope::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .songs-grid.view-zoetrope::-webkit-scrollbar-thumb {
      background: var(--accent-green);
      border-radius: 4px;
      box-shadow: 0 0 10px var(--accent-green);
    }
    .songs-grid.view-zoetrope::-webkit-scrollbar-thumb:hover {
      background: var(--accent-cyan);
      box-shadow: 0 0 15px var(--accent-cyan);
    }
    
    .songs-grid.view-zoetrope .song-card { min-width: 180px; max-width: 180px; scroll-snap-align: start; animation: float 3s ease-in-out infinite; }
    .songs-grid.view-zoetrope .song-card:nth-child(odd) { animation-delay: 0.5s; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    
    /* List View - Now shows notes */
    .songs-grid.view-list { grid-template-columns: 1fr; gap: 0.75rem; }
    .songs-grid.view-list .song-card { display: flex; flex-direction: row; clip-path: none; height: auto; }
    .songs-grid.view-list .song-card-image { width: 80px; height: 80px; padding-top: 0; flex-shrink: 0; }
    .songs-grid.view-list .song-card-info { display: flex; align-items: center; gap: 1rem; flex: 1; padding: 0.75rem 1rem; min-width: 0; }
    .songs-grid.view-list .song-card-rank { position: static; background: none; border: none; padding: 0; font-size: 0.9rem; color: var(--accent-green); font-family: 'Press Start 2P', cursive; min-width: 30px; text-align: center; }
    .songs-grid.view-list .song-card-type { position: static; }
    .songs-grid.view-list .song-card-notes { 
      display: -webkit-box !important; 
      margin-top: 0; 
      padding-top: 0; 
      border-top: none; 
      flex: 1;
      -webkit-line-clamp: 2;
      max-width: 200px;
      font-size: 0.6rem;
    }
    .songs-grid.view-list .song-card-name-artist {
      min-width: 150px;
      max-width: 200px;
    }
    .songs-grid.view-list .song-card-name { margin-bottom: 0.1rem; }
    .songs-grid.view-list .song-card-actions { margin-left: auto; opacity: 1; }
    
    /* Compact View - Now shows notes */
    .songs-grid.view-compact { grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .songs-grid.view-compact .song-card-info { padding: 0.5rem; }
    .songs-grid.view-compact .song-card-name { font-size: 0.7rem; }
    .songs-grid.view-compact .song-card-artist { font-size: 0.6rem; }
    .songs-grid.view-compact .song-card-notes { 
      display: -webkit-box !important; 
      font-size: 0.55rem; 
      margin-top: 0.3rem;
      padding-top: 0.3rem;
      -webkit-line-clamp: 2;
      line-height: 1.2;
      max-height: 2.4em;
    }
    .songs-grid.view-compact .song-card-actions { display: flex; }
    
    .song-card { background: var(--bg-card); overflow: hidden; cursor: pointer; transition: all 0.4s ease; border: 2px solid var(--border-color); position: relative; clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px); }
    .song-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan)); opacity: 0; transition: opacity 0.3s ease; z-index: 10; }
    .song-card:hover { transform: translateY(-5px); border-color: var(--accent-green); box-shadow: 0 0 30px color-mix(in srgb, var(--accent-green) 30%, transparent); }
    .song-card:hover::before { opacity: 1; }
    .song-card.has-notes { border-color: var(--accent-purple); }
    .song-card.has-notes::before { background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan)); opacity: 0.7; }
    .song-card:active { transform: translateY(-2px); }
    
    .song-card-image { position: relative; padding-top: 100%; background: var(--bg-secondary); overflow: hidden; }
    .song-card-image img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
    .song-card:hover .song-card-image img { transform: scale(1.1); }
    .song-card-rank { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.9); border: 2px solid var(--accent-green); padding: 0.2rem 0.4rem; font-family: 'Press Start 2P', cursive; font-size: 0.55rem; color: var(--accent-green); text-shadow: 0 0 5px var(--accent-green); }
    .song-card-type { position: absolute; top: 8px; left: 8px; }
    .type-badge { padding: 0.2rem 0.4rem; font-family: 'Share Tech Mono', monospace; font-size: 0.55rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; border: 1px solid; }
    .type-spotify { background: rgba(0,255,102,0.2); color: var(--accent-green); border-color: var(--accent-green); }
    .type-youtube { background: rgba(255,0,68,0.2); color: var(--accent-red); border-color: var(--accent-red); }
    
    .song-card-info { padding: 0.75rem; background: linear-gradient(180deg, var(--bg-card) 0%, color-mix(in srgb, var(--accent-green) 2%, transparent) 100%); min-height: 100px; display: flex; flex-direction: column; }
    .song-card-name { font-family: 'Orbitron', sans-serif; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-card-artist { font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: var(--accent-cyan); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: auto; }
    .song-card-notes { 
      font-family: 'Share Tech Mono', monospace; 
      font-size: 0.6rem; 
      color: var(--accent-purple); 
      margin-top: 0.4rem; 
      padding-top: 0.4rem; 
      border-top: 1px solid var(--border-color); 
      display: -webkit-box; 
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; 
      overflow: hidden; 
      line-height: 1.3; 
      text-shadow: 0 0 5px var(--accent-purple); 
      min-height: 2.6em;
    }
    /* Empty notes placeholder to maintain layout */
    .song-card-notes:empty::before {
      content: '\00A0';
      visibility: hidden;
    }
    .song-card-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; opacity: 0; transition: opacity 0.3s ease; }
    .song-card:hover .song-card-actions { opacity: 1; }
    .action-btn { padding: 0.25rem 0.4rem; font-size: 0.55rem; border: 1px solid; background: transparent; cursor: pointer; font-family: 'Share Tech Mono', monospace; transition: all 0.2s ease; touch-action: manipulation; min-height: 28px; }
    .action-btn.edit { color: var(--accent-cyan); border-color: var(--accent-cyan); }
    .action-btn.edit:hover { background: var(--accent-cyan); color: var(--bg-primary); }
    .action-btn.delete { color: var(--accent-red); border-color: var(--accent-red); }
    .action-btn.delete:hover { background: var(--accent-red); color: white; }
    
    /* Zoetrope specific card adjustments for notes */
    .songs-grid.view-zoetrope .song-card-info {
      min-height: 120px;
    }
    .songs-grid.view-zoetrope .song-card-notes {
      font-size: 0.55rem;
      -webkit-line-clamp: 3;
      max-height: 3.9em;
    }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-modal); width: 100%; max-width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--accent-green); box-shadow: 0 0 50px color-mix(in srgb, var(--accent-green) 30%, transparent); animation: modalSlideIn 0.4s ease; position: relative; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); }
    .modal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan), var(--accent-purple)); }
    @keyframes modalSlideIn { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .modal-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, color-mix(in srgb, var(--accent-green) 5%, transparent) 0%, transparent 100%); }
    .modal-header h2 { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--accent-green); text-shadow: 0 0 10px var(--accent-green); text-transform: uppercase; letter-spacing: 2px; }
    .modal-close { width: 32px; height: 32px; background: transparent; border: 2px solid var(--accent-red); color: var(--accent-red); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.3s ease; min-height: 32px; }
    .modal-close:hover { background: var(--accent-red); color: var(--bg-primary); }
    .modal-body { padding: 1rem; }
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; margin-bottom: 0.3rem; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px; }
    .form-label .required { color: var(--accent-red); }
    .form-input { width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 2px solid var(--border-color); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; min-height: 44px; }
    .form-input:focus { outline: none; border-color: var(--accent-green); box-shadow: 0 0 20px color-mix(in srgb, var(--accent-green) 20%, transparent); }
    .form-input::placeholder { color: var(--text-muted); }
    textarea.form-input { resize: vertical; min-height: 80px; }
    .form-hint { font-family: 'Share Tech Mono', monospace; font-size: 0.6rem; color: var(--text-muted); margin-top: 0.3rem; }
    .form-actions { display: flex; gap: 0.75rem; margin-top: 1.25rem; }
    
    .detail-modal { max-width: 500px; }
    .detail-header { position: relative; height: 200px; background: var(--bg-secondary); overflow: hidden; }
    .detail-header img { width: 100%; height: 100%; object-fit: cover; }
    .detail-header-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem; background: linear-gradient(transparent, rgba(0,0,0,0.95)); }
    .detail-rank { display: inline-block; background: var(--bg-primary); border: 2px solid var(--accent-green); color: var(--accent-green); padding: 0.3rem 0.6rem; font-family: 'Press Start 2P', cursive; font-size: 0.7rem; margin-bottom: 0.5rem; text-shadow: 0 0 10px var(--accent-green); }
    .detail-type-badge { margin-left: 0.5rem; }
    .detail-title { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; word-break: break-word; }
    .detail-artist { font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; color: var(--accent-cyan); }
    .detail-body { padding: 1rem; }
    .detail-section { margin-bottom: 1rem; }
    .detail-section-title { font-family: 'Share Tech Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 0.3rem; }
    .detail-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--accent-green); text-decoration: none; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; text-shadow: 0 0 5px var(--accent-green); word-break: break-all; }
    .detail-link:hover { color: var(--accent-cyan); }
    .detail-actions { display: flex; gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); }
    
    .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; max-width: 90vw; pointer-events: none; }
    .toast { background: var(--bg-card); border: 2px solid var(--border-color); padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.5rem; animation: toastSlideIn 0.4s ease; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; pointer-events: auto; }
    @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    .toast.success { border-color: var(--accent-green); }
    .toast.error { border-color: var(--accent-red); }
    .toast-icon { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .toast.success .toast-icon { color: var(--accent-green); }
    .toast.error .toast-icon { color: var(--accent-red); }
    
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .empty-state h3 { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; color: var(--accent-green); margin-bottom: 0.5rem; }
    .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--text-muted); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .confirm-dialog { text-align: center; }
    .confirm-dialog p { margin-bottom: 1.25rem; font-family: 'Share Tech Mono', monospace; color: var(--text-secondary); font-size: 0.85rem; }
    .confirm-actions { display: flex; gap: 0.75rem; justify-content: center; }

    /* Tablet and up */
    @media (min-width: 640px) {
      .container { padding: 1.5rem; }
      .songs-grid { grid-template-columns: repeat(3, 1fr); gap: 1.25rem; }
      .songs-grid.view-compact { grid-template-columns: repeat(4, 1fr); }
      .songs-grid.view-zoetrope .song-card { min-width: 200px; max-width: 200px; }
      .logo h1 { font-size: 0.9rem; }
      .logo-icon { width: 60px; height: 60px; }
    }
    
    /* Desktop */
    @media (min-width: 1024px) {
      .container { padding: 2rem; }
      .songs-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
      .songs-grid.view-compact { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .songs-grid.view-list .song-card-notes { max-width: 300px; }
      .logo h1 { font-size: 1rem; }
      .logo-icon { width: 70px; height: 70px; }
      .btn { padding: 0.75rem 1.25rem; font-size: 0.8rem; }
      .theme-picker { order: 0; width: auto; margin-bottom: 0; margin-right: 1rem; }
      .header-actions { flex-wrap: nowrap; }
      .controls-right { gap: 1rem; }
      .stat-value { font-size: 2rem; }
      .modal { max-width: 500px; }
      .detail-header { height: 250px; }
    }
    
    /* Mobile-specific touch improvements */
    @media (hover: none) and (pointer: coarse) {
      .song-card-actions { opacity: 1; }
      .song-card:hover { transform: translateY(-3px); }
    }
  </style>
</head>
<body>
  <div class="crt-overlay"></div>
  <div class="bg-gradient"></div>
  <div class="grid-overlay"></div>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">
          <img src="amba-logo.gif" alt="Amba" onerror="this.parentElement.innerHTML='ðŸŽµ'">
        </div>
        <h1>Amba Moodboard</h1>
      </div>
      <div class="header-actions">
        <div class="theme-picker">
          <button class="theme-btn cyber active" onclick="setTheme('')" title="Cyber"></button>
          <button class="theme-btn vapor" onclick="setTheme('vapor')" title="Vapor"></button>
          <button class="theme-btn sunset" onclick="setTheme('sunset')" title="Sunset"></button>
          <button class="theme-btn matrix" onclick="setTheme('matrix')" title="Matrix"></button>
          <button class="theme-btn ocean" onclick="setTheme('ocean')" title="Ocean"></button>
          <button class="theme-btn sakura" onclick="setTheme('sakura')" title="Sakura"></button>
        </div>
        <button class="btn btn-secondary" onclick="refreshData()"><span>â†»</span> Refresh</button>
        <button class="btn btn-primary" onclick="playYouTubePlaylist()" title="Open ranked YouTube songs in playlist"><span>â–¶</span> YT Play</button>
        <button class="btn btn-primary" onclick="openAddModal()"><span>+</span> Add</button>
      </div>
    </header>
    
    <div class="controls-bar">
      <div class="controls-box">
        <div class="stat"><div class="stat-value" id="totalSongs">0</div><div class="stat-label">Total</div></div>
        <div class="stat"><div class="stat-value" id="spotifyCount">0</div><div class="stat-label">Spotify</div></div>
        <div class="stat"><div class="stat-value" id="youtubeCount">0</div><div class="stat-label">YouTube</div></div>
        <div class="controls-right">
          <div class="control-group">
            <label class="control-label">View:</label>
            <select class="control-select" id="viewSelect" onchange="handleViewChange()">
              <option value="grid">Grid</option>
              <option value="list">List</option>
              <option value="zoetrope">Zoetrope</option>
              <option value="compact">Compact</option>
            </select>
          </div>
          <div class="control-group">
            <label class="control-label">Sort:</label>
            <select class="control-select" id="sortSelect" onchange="handleSort()">
              <option value="rank-asc">Rank â†‘</option>
              <option value="rank-desc">Rank â†“</option>
              <option value="name-asc">Name A-Z</option>
              <option value="name-desc">Name Z-A</option>
              <option value="artist-asc">Artist A-Z</option>
              <option value="artist-desc">Artist Z-A</option>
              <option value="notes">Has Notes</option>
            </select>
          </div>
          <div class="control-group">
            <label class="control-label">Filter:</label>
            <select class="control-select" id="filterSelect" onchange="handleSort()">
              <option value="all">All</option>
              <option value="spotify">Spotify</option>
              <option value="youtube">YouTube</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <div class="songs-grid" id="songsGrid"></div>
    <div class="empty-state" id="emptyState" style="display: none;"><div class="empty-state-icon">ðŸŽ§</div><h3>No songs yet</h3><p>Add your first song!</p></div>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Song</h2>
        <button class="modal-close" onclick="closeAddModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="addSongForm" onsubmit="handleFormSubmit(event)">
          <input type="hidden" id="editRowIndex" value="">
          <input type="hidden" id="editSheetName" value="">
          <div class="form-group" id="linkGroup">
            <label class="form-label">Song Link <span class="required">*</span></label>
            <input type="url" class="form-input" id="songLink" placeholder="Spotify or YouTube URL" required inputmode="url">
            <div class="form-hint">Paste a Spotify or YouTube link</div>
          </div>
          <div class="form-group">
            <label class="form-label">Rank <span class="required">*</span></label>
            <input type="number" class="form-input" id="songRank" placeholder="1" min="1" required inputmode="numeric">
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-input" id="songNotes" placeholder="Optional notes..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;" id="submitBtn">Add Song</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="detailModal">
    <div class="modal detail-modal">
      <div class="detail-header">
        <img id="detailImage" src="" alt="">
        <button class="modal-close" onclick="closeDetailModal()" style="position:absolute;top:1rem;right:1rem;">Ã—</button>
        <div class="detail-header-overlay">
          <div class="detail-rank" id="detailRank">#1</div><span class="detail-type-badge" id="detailTypeBadge"></span>
          <h2 class="detail-title" id="detailTitle">Song</h2>
          <p class="detail-artist" id="detailArtist">Artist</p>
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-section" id="detailNotesSection">
          <div class="detail-section-title">Notes</div>
          <div id="detailNotes" style="font-size: 0.85rem; line-height: 1.5;"></div>
        </div>
        <div class="detail-section">
          <div class="detail-section-title">Listen</div>
          <a class="detail-link" id="detailLink" href="#" target="_blank">Open in app â†’</a>
        </div>
        <div class="detail-actions">
          <button class="btn btn-secondary btn-small" onclick="editCurrentSong()">âœŽ Edit</button>
          <button class="btn btn-danger btn-small" onclick="deleteCurrentSong()">âœ• Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
        <button class="modal-close" onclick="closeConfirmModal()">Ã—</button>
      </div>
      <div class="modal-body confirm-dialog">
        <p>Are you sure you want to delete this song?</p>
        <div class="confirm-actions">
          <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz9DeHlVgG844DOx8eXKG-6GrzkszW_q-rkXYaEyK8wAo87zm4y0FtNyQRuJfeiBZWn/exec';
    let songs = [];
    let currentSong = null;
    let isEditMode = false;

    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('amba-theme') || '';
      setTheme(savedTheme, false);
      fetchSongs();
    });

    function setTheme(theme, save = true) {
      document.body.className = theme ? `theme-${theme}` : '';
      document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.theme-btn.${theme || 'cyber'}`).classList.add('active');
      if (save) localStorage.setItem('amba-theme', theme);
    }

    function getAlbumArtFallback(link) {
      if (link && (link.includes('youtube.com') || link.includes('youtu.be'))) {
        const match = link.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
        if (match) return `https://img.youtube.com/vi/${match[1]}/hqdefault.jpg`;
      }
      return '';
    }

    async function fetchSongs() {
      try {
        const response = await fetch(`${API_URL}?action=getSongs&t=${Date.now()}`, { method: 'GET', redirect: 'follow' });
        const data = await response.json();
        if (data.success) {
          songs = (data.songs || []).map(song => ({
            ...song,
            albumArt: song.albumArt || getAlbumArtFallback(song.link),
            type: song.type || (song.link.includes('youtube') || song.link.includes('youtu.be') ? 'youtube' : 'spotify')
          }));
          renderSongs();
          showToast(`Loaded ${songs.length} songs`, 'success');
        }
      } catch (err) { 
        console.error(err); 
        showToast('Error loading songs', 'error'); 
      }
    }

    function handleSort() { renderSongs(); }
    function handleViewChange() { renderSongs(); }

    function getSortedFilteredSongs() {
      const sortValue = document.getElementById('sortSelect').value;
      const filterValue = document.getElementById('filterSelect').value;
      let filtered = [...songs];
      if (filterValue === 'spotify') filtered = filtered.filter(s => s.type === 'spotify');
      else if (filterValue === 'youtube') filtered = filtered.filter(s => s.type === 'youtube');
      
      filtered.sort((a, b) => {
        switch(sortValue) {
          case 'rank-asc': return (parseInt(a.rank) || 999) - (parseInt(b.rank) || 999);
          case 'rank-desc': return (parseInt(b.rank) || 0) - (parseInt(a.rank) || 0);
          case 'name-asc': return (a.songName || '').localeCompare(b.songName || '');
          case 'name-desc': return (b.songName || '').localeCompare(a.songName || '');
          case 'artist-asc': return (a.artist || '').localeCompare(b.artist || '');
          case 'artist-desc': return (b.artist || '').localeCompare(a.artist || '');
          case 'notes': 
            // Has notes first, then by rank
            const aHasNotes = a.notes && a.notes.trim() ? 1 : 0;
            const bHasNotes = b.notes && b.notes.trim() ? 1 : 0;
            if (aHasNotes !== bHasNotes) return bHasNotes - aHasNotes;
            return (parseInt(a.rank) || 999) - (parseInt(b.rank) || 999);
          default: return 0;
        }
      });
      return filtered;
    }

    function extractYouTubeId(url) {
      const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      return match ? match[1] : null;
    }

    function playYouTubePlaylist() {
      const filtered = getSortedFilteredSongs();
      const ranked = filtered.filter(s => s.type === 'youtube' && s.rank && parseInt(s.rank) > 0)
                             .sort((a, b) => parseInt(a.rank) - parseInt(b.rank));
      
      if (ranked.length === 0) {
        showToast('No ranked YouTube songs found. Add ranks to YouTube songs first!', 'error');
        return;
      }

      const ids = ranked.map(s => extractYouTubeId(s.link)).filter(id => id);
      
      if (ids.length === 0) {
        showToast('Could not extract YouTube video IDs', 'error');
        return;
      }

      window.open(`https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`, '_blank');
      showToast(`Opening ${ids.length} ranked YouTube videos...`, 'success');
    }

    function getPlaceholderArt(i) { 
      const c = ['00ff66','ff00ff','00ffff','ff6600','ff0044']; 
      return `https://via.placeholder.com/300/${c[i%c.length]}/000?text=â™ª`; 
    }

    function renderSongs() {
      const grid = document.getElementById('songsGrid');
      const empty = document.getElementById('emptyState');
      const viewMode = document.getElementById('viewSelect').value;
      
      grid.className = `songs-grid view-${viewMode}`;
      
      const spotify = songs.filter(s => s.type === 'spotify').length;
      const youtube = songs.filter(s => s.type === 'youtube').length;
      document.getElementById('totalSongs').textContent = songs.length;
      document.getElementById('spotifyCount').textContent = spotify;
      document.getElementById('youtubeCount').textContent = youtube;
      
      const display = getSortedFilteredSongs();
      if (!display.length) { 
        grid.style.display = 'none'; 
        empty.style.display = 'block'; 
        return; 
      }
      
      grid.style.display = viewMode === 'zoetrope' ? 'flex' : 'grid'; 
      empty.style.display = 'none';
      
      grid.innerHTML = display.map((s, i) => {
        const isSpotify = s.type === 'spotify';
        const hasNotes = s.notes && s.notes.trim();
        const encoded = encodeURIComponent(JSON.stringify(s));
        
        // Notes HTML - shown in all views, shows content or blank placeholder
        const notesHtml = `<div class="song-card-notes">${hasNotes ? s.notes : ''}</div>`;
        
        // List view structure is different
        if (viewMode === 'list') {
          return `<div class="song-card ${hasNotes ? 'has-notes' : ''}" onclick="openDetailModal('${encoded}')">
            <div class="song-card-image">
              <img src="${s.albumArt || getPlaceholderArt(i)}" onerror="this.src='${getPlaceholderArt(i)}'" loading="lazy">
              <div class="song-card-type"><span class="type-badge ${isSpotify ? 'type-spotify' : 'type-youtube'}">${isSpotify ? 'Spotify' : 'YouTube'}</span></div>
            </div>
            <div class="song-card-info">
              <div class="song-card-rank">#${s.rank || '?'}</div>
              <div class="song-card-name-artist">
                <div class="song-card-name">${s.songName || 'Unknown'}</div>
                <div class="song-card-artist">${s.artist || 'Unknown'}</div>
              </div>
              ${notesHtml}
              <div class="song-card-actions">
                <button class="action-btn edit" onclick="event.stopPropagation(); editSong('${encoded}')">Edit</button>
                <button class="action-btn delete" onclick="event.stopPropagation(); deleteSong('${encoded}')">Delete</button>
              </div>
            </div>
          </div>`;
        }
        
        // Grid, Compact, Zoetrope views
        return `<div class="song-card ${hasNotes ? 'has-notes' : ''}" onclick="openDetailModal('${encoded}')">
          <div class="song-card-image">
            <img src="${s.albumArt || getPlaceholderArt(i)}" onerror="this.src='${getPlaceholderArt(i)}'" loading="lazy">
            <div class="song-card-rank">#${s.rank || '?'}</div>
            <div class="song-card-type"><span class="type-badge ${isSpotify ? 'type-spotify' : 'type-youtube'}">${isSpotify ? 'Spotify' : 'YouTube'}</span></div>
          </div>
          <div class="song-card-info">
            <div class="song-card-name">${s.songName || 'Unknown'}</div>
            <div class="song-card-artist">${s.artist || 'Unknown'}</div>
            ${notesHtml}
            <div class="song-card-actions">
              <button class="action-btn edit" onclick="event.stopPropagation(); editSong('${encoded}')">Edit</button>
              <button class="action-btn delete" onclick="event.stopPropagation(); deleteSong('${encoded}')">Delete</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    async function addSong(link, rank, notes) {
      try {
        const params = new URLSearchParams({ action: 'addSong', link, rank, notes: notes || '', t: Date.now() });
        const response = await fetch(`${API_URL}?${params}`, { method: 'GET', redirect: 'follow' });
        const data = await response.json();
        if (data.success) { showToast('Song added!', 'success'); fetchSongs(); }
        else showToast(data.error || 'Failed', 'error');
        return data;
      } catch (err) { 
        showToast('Failed', 'error'); 
        return { success: false }; 
      }
    }

    async function updateSong(rowIndex, sheetName, rank, notes) {
      try {
        const params = new URLSearchParams({ action: 'updateSong', rowIndex, sheetName, rank, notes: notes || '', t: Date.now() });
        const response = await fetch(`${API_URL}?${params}`, { method: 'GET', redirect: 'follow' });
        const data = await response.json();
        if (data.success) { showToast('Song updated!', 'success'); fetchSongs(); }
        else showToast(data.error || 'Failed', 'error');
        return data;
      } catch (err) { 
        showToast('Failed to update', 'error'); 
        return { success: false }; 
      }
    }

    async function deleteSongAPI(rowIndex, sheetName) {
      try {
        const params = new URLSearchParams({ action: 'deleteSong', rowIndex, sheetName, t: Date.now() });
        const response = await fetch(`${API_URL}?${params}`, { method: 'GET', redirect: 'follow' });
        const data = await response.json();
        if (data.success) { showToast('Song deleted!', 'success'); fetchSongs(); }
        else showToast(data.error || 'Failed', 'error');
        return data;
      } catch (err) { 
        showToast('Failed to delete', 'error'); 
        return { success: false }; 
      }
    }

    async function refreshData() {
      showToast('Refreshing...', 'success');
      try {
        await fetch(`${API_URL}?action=fillEmptyMetadata&t=${Date.now()}`, { method: 'GET', redirect: 'follow' });
        await fetchSongs();
        showToast('Refreshed!', 'success');
      } catch (err) { 
        showToast('Failed', 'error'); 
      }
    }

    function openAddModal() {
      isEditMode = false;
      document.getElementById('modalTitle').textContent = 'Add New Song';
      document.getElementById('linkGroup').style.display = 'block';
      document.getElementById('songLink').required = true;
      document.getElementById('submitBtn').textContent = 'Add Song';
      document.getElementById('addSongForm').reset();
      document.getElementById('editRowIndex').value = '';
      document.getElementById('editSheetName').value = '';
      document.getElementById('addModal').classList.add('active');
      document.getElementById('songLink').focus();
    }

    function closeAddModal() { 
      document.getElementById('addModal').classList.remove('active'); 
    }

    function editSong(encoded) {
      const s = JSON.parse(decodeURIComponent(encoded));
      isEditMode = true;
      document.getElementById('modalTitle').textContent = 'Edit Song';
      document.getElementById('linkGroup').style.display = 'none';
      document.getElementById('songLink').required = false;
      document.getElementById('submitBtn').textContent = 'Save Changes';
      document.getElementById('songRank').value = s.rank || '';
      document.getElementById('songNotes').value = s.notes || '';
      document.getElementById('editRowIndex').value = s.rowIndex;
      document.getElementById('editSheetName').value = s.sheetName;
      document.getElementById('addModal').classList.add('active');
      document.getElementById('songRank').focus();
    }

    function editCurrentSong() {
      if (currentSong) {
        closeDetailModal();
        editSong(encodeURIComponent(JSON.stringify(currentSong)));
      }
    }

    function deleteSong(encoded) {
      currentSong = JSON.parse(decodeURIComponent(encoded));
      document.getElementById('confirmModal').classList.add('active');
    }

    function deleteCurrentSong() {
      if (currentSong) {
        closeDetailModal();
        document.getElementById('confirmModal').classList.add('active');
      }
    }

    function closeConfirmModal() { 
      document.getElementById('confirmModal').classList.remove('active'); 
    }

    async function confirmDelete() {
      if (currentSong) {
        closeConfirmModal();
        await deleteSongAPI(currentSong.rowIndex, currentSong.sheetName);
        currentSong = null;
      }
    }

    function openDetailModal(encoded) {
      const s = JSON.parse(decodeURIComponent(encoded));
      currentSong = s;
      document.getElementById('detailImage').src = s.albumArt || getPlaceholderArt(0);
      document.getElementById('detailRank').textContent = `#${s.rank || '?'}`;
      document.getElementById('detailTitle').textContent = s.songName || 'Unknown';
      document.getElementById('detailArtist').textContent = s.artist || 'Unknown';
      document.getElementById('detailLink').href = s.link;
      document.getElementById('detailTypeBadge').innerHTML = s.type === 'spotify' ? '<span class="type-badge type-spotify">Spotify</span>' : '<span class="type-badge type-youtube">YouTube</span>';
      const notesSection = document.getElementById('detailNotesSection');
      if (s.notes) { 
        notesSection.style.display = 'block'; 
        document.getElementById('detailNotes').textContent = s.notes; 
      } else { 
        notesSection.style.display = 'none'; 
      }
      document.getElementById('detailModal').classList.add('active');
    }

    function closeDetailModal() { 
      document.getElementById('detailModal').classList.remove('active'); 
    }

    document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { 
      if (e.target === o) o.classList.remove('active'); 
    }));
    
    document.addEventListener('keydown', e => { 
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(o => o.classList.remove('active')); 
    });

    async function handleFormSubmit(e) {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.innerHTML = '<span class="loading-spinner"></span> Saving...'; 
      btn.disabled = true;
      
      if (isEditMode) {
        const rowIndex = document.getElementById('editRowIndex').value;
        const sheetName = document.getElementById('editSheetName').value;
        const rank = document.getElementById('songRank').value;
        const notes = document.getElementById('songNotes').value.trim();
        const result = await updateSong(rowIndex, sheetName, rank, notes);
        btn.innerHTML = 'Save Changes'; 
        btn.disabled = false;
        if (result.success) closeAddModal();
      } else {
        const link = document.getElementById('songLink').value.trim();
        const rank = document.getElementById('songRank').value;
        const notes = document.getElementById('songNotes').value.trim();
        if (!link.includes('spotify.com') && !link.includes('youtube.com') && !link.includes('youtu.be')) {
          showToast('Invalid link', 'error');
          btn.innerHTML = 'Add Song'; 
          btn.disabled = false;
          return;
        }
        const result = await addSong(link, rank, notes);
        btn.innerHTML = 'Add Song'; 
        btn.disabled = false;
        if (result.success) closeAddModal();
      }
    }

    function showToast(msg, type = 'success') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="toast-icon">${type === 'success' ? 'âœ“' : '!'}</div><span>${msg}</span>`;
      c.appendChild(t);
      setTimeout(() => { 
        t.style.opacity = '0'; 
        setTimeout(() => t.remove(), 300); 
      }, 3000);
    }
  </script>
</body>
</html>